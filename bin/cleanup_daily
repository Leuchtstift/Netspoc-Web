#!/bin/sh

usage () { echo "Usage: $0 <config>"; exit 1; }

config=$1
link=current

# Abort on any untested error.
set -e

abort () { [ "$1" ] && echo "Error: $1"; usage; }

read_conf () { 
    grep "\"$1\"" $config | cut -d: -f2 | cut -d'"' -f 2
}

[ -n "$config" ] || usage
[ -f "$config" ] || abort "Can't read '$config'"
dir=$(read_conf netspoc_data)
cd $dir
current=$(readlink $link)
[ "$current" ] || abort "Can't read $dir/current"

version=$current
mkdir -p RCS

if [ -f RCS/POLICY,v ] ; then

    # Nothing to do, if current version has already been processed.
    prev_ver=$(rlog RCS/POLICY,v |grep -A1 date:|head -2|grep -v date:)
    [ $version = $prev_ver ] && exit

    # Compare current version with latest checked in version.
    # Mark each changed owner by copying the topelevel POLICY file
    # into the owners directory.
    prev_date=$(rlog -zLT RCS/POLICY,v |grep date:|head -1|cut -d ' ' -f 2)
    changed=$(~/NetspocWeb/bin/diff.pl . $prev_date $current)
    for owner in $changed; do

        # Copy current POLICY file to owner, if diff was found. 
        # Preserve date of file for RCS.
        cp -p $current/POLICY $current/owner/$owner
    done
else
    # Mark all owner as changed on initial checkin.
    for opath in $current/owner/* ; do
        cp -p $current/POLICY $opath
    done
        
fi

# Add current version to RCS.
~/NetspocWeb/bin/add_to_rcs $current RCS $version

# Remove all versions except current one.
for f in p* ; do
    case $f in
	$current)
	    ;;
	*)
	    rm -rf $f
	    ;;
    esac
done