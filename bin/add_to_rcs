#!/bin/sh

usage () { echo "Usage: $0 <in_dir> <RCS_dir> <RCS_msg>"; }

dir=$1
RCS=$2
msg=$3

# Abort on any untested error.
set -e

abort () { [ "$1" ] && echo "Error: $1"; usage; exit 1; }

[ -d "$dir" ] || abort "Missing input directory '$dir'"
[ -d "$RCS" ] || abort "Missing output directory '$RCS'"
[ "$msg" ] || abort "Missing message parameter";

for f in $(cd $dir && find . -type f) ; do
    rcsfile=$RCS/$f,v
    if [ ! -e $rcsfile ] ; then
	rcsdir=$(dirname $rcsfile)
	mkdir -p $rcsdir
	rcs -q -i -t-init $rcsfile
    fi

    # Lock RCS file for next call of ci.
    # Use working file's time of last modification.
    ci -q -l -d -m"$msg" $rcsfile $dir/$f
done
